{% extends "base.html" %}

{% block title %}Auxiliary Engines - {{ vessel.vessel_name }}{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Breadcrumb and Title -->
    <div class="row mb-3">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('dashboard') }}">Dashboard</a></li>
                    <li class="breadcrumb-item active">Auxiliary Engines</li>
                </ol>
            </nav>
            <h2><i class="bi bi-gear text-warning"></i> Auxiliary Engines Analysis</h2>
            <p class="text-muted">{{ vessel.vessel_name }}</p>
        </div>
    </div>

    <!-- Main Layout Row -->
    <div class="row">
        <!-- Left Sidebar -->
        <div class="col-lg-3 col-md-4">
            <!-- Date Range Filter -->
            <div class="card shadow-sm mb-3">
                <div class="card-header bg-primary text-white">
                    <h6 class="mb-0"><i class="bi bi-calendar-range"></i> Date Range</h6>
                </div>
                <div class="card-body">
                    <form method="GET">
                        <div class="mb-3">
                            <label for="start_date" class="form-label"><strong>Start Date</strong></label>
                            <input type="date" class="form-control" id="start_date"
                                   name="start_date" value="{{ start_date }}">
                        </div>
                        <div class="mb-3">
                            <label for="end_date" class="form-label"><strong>End Date</strong></label>
                            <input type="date" class="form-control" id="end_date"
                                   name="end_date" value="{{ end_date }}">
                        </div>
                        <button type="submit" class="btn btn-primary w-100 mb-2">
                            <i class="bi bi-funnel"></i> Apply Filter
                        </button>
                        <button type="button" class="btn btn-outline-secondary w-100"
                                onclick="window.location.href='{{ url_for('aux_engines') }}'">
                            <i class="bi bi-x-circle"></i> Reset
                        </button>
                    </form>
                </div>
            </div>

            <!-- Engine Selection Card -->
            <div class="card shadow-sm sticky-top" style="top: 20px;">
                <div class="card-header bg-primary text-white">
                    <h6 class="mb-0"><i class="bi bi-gear-fill"></i> Select Engines</h6>
                </div>
                <div class="card-body">
                    {% for i in range(1, 4) %}
                    <div class="form-check mb-3">
                        <input class="form-check-input engine-checkbox" type="checkbox"
                               id="ae{{ i }}" value="{{ i }}" checked>
                        <label class="form-check-label fw-bold" for="ae{{ i }}">
                            <i class="bi bi-gear-fill text-warning"></i> AE {{ i }}
                        </label>
                    </div>
                    {% endfor %}
                    <hr>
                    <button class="btn btn-sm btn-outline-primary w-100 mb-2" onclick="selectAllEngines()">
                        <i class="bi bi-check-all"></i> Select All
                    </button>
                    <button class="btn btn-sm btn-outline-secondary w-100" onclick="deselectAllEngines()">
                        <i class="bi bi-x-circle"></i> Deselect All
                    </button>
                </div>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="col-lg-9 col-md-8">
            <!-- Cooling Water Charts -->
            <div class="card mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="bi bi-thermometer-half"></i> Cooling Water</h5>
                </div>
                <div class="card-body">
                    <div id="cooling-charts"></div>
                </div>
            </div>

            <!-- Lubricating Oil Table -->
            <div class="card mb-4">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0"><i class="bi bi-droplet"></i> Lubricating Oil</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="lube-oil-table">
                            <thead>
                                <tr>
                                    <th>Engine</th>
                                    <th>Date</th>
                                    <th>Parameter</th>
                                    <th>Value</th>
                                    <th>Unit</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="lube-oil-tbody">
                                <!-- Populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="{{ url_for('static', filename='js/plotly-2.27.0.min.js') }}"></script>
<script>
// Color palette for engines (only 3 engines now)
const ENGINE_COLORS = {
    1: '#2196F3',  // Blue
    2: '#4CAF50',  // Green
    3: '#FF9800'   // Orange
};

const ENGINE_NAMES = {
    1: 'AE1',
    2: 'AE2',
    3: 'AE3'
};

// All engines data from backend
const allEnginesData = {{ all_engines_data | tojson }};

// Current chart state
let coolingCharts = {};
let selectedEngines = new Set([1, 2, 3]); // Initially all 3 selected

// ============================================================================
// DATA ORGANIZATION
// ============================================================================

function organizeDataByParameter(engineNum, coolingData) {
    const byParam = {};

    if (!coolingData || coolingData.length === 0) {
        return byParam;
    }

    coolingData.forEach(m => {
        const paramName = m.parameter_name;
        if (!byParam[paramName]) {
            byParam[paramName] = {
                dates: [],
                values: [],
                statuses: []
            };
        }
        byParam[paramName].dates.push(m.measurement_date);
        byParam[paramName].values.push(m.value_numeric);
        byParam[paramName].statuses.push(m.ideal_status);
    });

    return byParam;
}

function getMarkerSymbol(engineNum) {
    const symbols = ['circle', 'square', 'diamond'];
    return symbols[engineNum - 1];
}

// ============================================================================
// CHART CREATION
// ============================================================================

function createCoolingCharts() {
    const container = document.getElementById('cooling-charts');
    container.innerHTML = '';

    // Get all unique parameters across all engines
    const allParams = new Set();
    Object.keys(allEnginesData).forEach(engineNum => {
        const data = organizeDataByParameter(engineNum, allEnginesData[engineNum].cooling);
        Object.keys(data).forEach(param => allParams.add(param));
    });

    if (allParams.size === 0) {
        container.innerHTML = '<div class="alert alert-info mb-0"><i class="bi bi-info-circle"></i> No cooling water data available for the selected date range.</div>';
        return;
    }

    // Create one chart per parameter
    allParams.forEach(paramName => {
        const chartDiv = document.createElement('div');
        chartDiv.id = `chart-${paramName.replace(/\s+/g, '-').replace(/[()]/g, '')}`;
        chartDiv.style.marginBottom = '30px';
        container.appendChild(chartDiv);

        const layout = {
            title: {
                text: paramName,
                font: { size: 18 }
            },
            xaxis: {
                title: 'Date',
                type: 'date'
            },
            yaxis: {
                title: 'Value'
            },
            hovermode: 'closest',
            showlegend: true,
            legend: {
                orientation: 'h',
                y: -0.2
            }
        };

        // Create empty plot
        Plotly.newPlot(chartDiv, [], layout, { responsive: true });
        coolingCharts[paramName] = chartDiv;

        // Add traces for currently selected engines
        updateChartTraces(paramName);
    });
}

// ============================================================================
// TRACE MANAGEMENT
// ============================================================================

function updateChartTraces(paramName) {
    const chartDiv = coolingCharts[paramName];
    if (!chartDiv) return;

    // Clear all existing traces
    const currentTraceCount = chartDiv.data ? chartDiv.data.length : 0;
    if (currentTraceCount > 0) {
        const indices = Array.from({length: currentTraceCount}, (_, i) => i);
        Plotly.deleteTraces(chartDiv, indices);
    }

    // Add traces for selected engines
    const newTraces = [];
    selectedEngines.forEach(engineNum => {
        const engineData = organizeDataByParameter(engineNum, allEnginesData[engineNum].cooling);

        if (engineData[paramName]) {
            const data = engineData[paramName];
            const trace = {
                x: data.dates,
                y: data.values,
                mode: 'lines+markers',
                name: ENGINE_NAMES[engineNum],
                line: {
                    color: ENGINE_COLORS[engineNum],
                    width: 2
                },
                marker: {
                    size: 6,
                    color: ENGINE_COLORS[engineNum],
                    symbol: getMarkerSymbol(engineNum)
                }
            };
            newTraces.push(trace);
        }
    });

    if (newTraces.length > 0) {
        Plotly.addTraces(chartDiv, newTraces);
    }
}

function updateAllCharts() {
    Object.keys(coolingCharts).forEach(paramName => {
        updateChartTraces(paramName);
    });
    updateLubeTable();
}

// ============================================================================
// ENGINE SELECTION HANDLERS
// ============================================================================

function selectAllEngines() {
    selectedEngines = new Set([1, 2, 3]);
    document.querySelectorAll('.engine-checkbox').forEach(cb => cb.checked = true);
    updateAllCharts();
}

function deselectAllEngines() {
    selectedEngines.clear();
    document.querySelectorAll('.engine-checkbox').forEach(cb => cb.checked = false);
    updateAllCharts();
}

// ============================================================================
// LUBE OIL TABLE
// ============================================================================

function updateLubeTable() {
    const tbody = document.getElementById('lube-oil-tbody');
    tbody.innerHTML = '';

    selectedEngines.forEach(engineNum => {
        const lubeData = allEnginesData[engineNum].lube;

        if (!lubeData || lubeData.length === 0) {
            return;
        }

        lubeData.forEach(measurement => {
            const row = document.createElement('tr');

            let statusClass = 'bg-success';
            if (measurement.ideal_status === 'TOO LOW' || measurement.ideal_status === 'TOO HIGH') {
                statusClass = 'bg-danger';
            } else if (measurement.ideal_status !== 'OKAY') {
                statusClass = 'bg-warning text-dark';
            }

            row.innerHTML = `
                <td><strong style="color: ${ENGINE_COLORS[engineNum]}">${ENGINE_NAMES[engineNum]}</strong></td>
                <td>${measurement.measurement_date.substring(0, 10)}</td>
                <td>${measurement.parameter_name}</td>
                <td><strong>${measurement.value}</strong></td>
                <td>${measurement.unit}</td>
                <td><span class="badge ${statusClass}">${measurement.ideal_status}</span></td>
            `;

            tbody.appendChild(row);
        });
    });

    if (selectedEngines.size === 0 || tbody.children.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No data available</td></tr>';
    }
}

// ============================================================================
// INITIALIZATION
// ============================================================================

document.addEventListener('DOMContentLoaded', function() {
    // Initialize charts
    createCoolingCharts();
    updateLubeTable();

    // Attach checkbox listeners
    document.querySelectorAll('.engine-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const engineNum = parseInt(this.value);

            if (this.checked) {
                selectedEngines.add(engineNum);
            } else {
                selectedEngines.delete(engineNum);
            }

            updateAllCharts();
        });
    });
});
</script>
{% endblock %}
