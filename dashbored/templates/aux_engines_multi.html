{% extends "base.html" %}

{% block title %}Auxiliary Engines - {{ vessel.vessel_name }}{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Breadcrumb and Title -->
    <div class="row mb-3">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('dashboard') }}">Dashboard</a></li>
                    <li class="breadcrumb-item active">Auxiliary Engines</li>
                </ol>
            </nav>
            <h2><i class="bi bi-gear text-success"></i> Auxiliary Engines Analysis</h2>
            <p class="text-muted">{{ vessel.vessel_name }} - {{ vessel.vessel_id }}</p>
        </div>
    </div>

    <div class="row">
        <!-- Left Sidebar -->
        <div class="col-md-3 col-lg-2 mb-4">
            <!-- Engine Selection -->
            <div class="card mb-3">
                <div class="card-body">
                    <h6 class="card-title"><i class="bi bi-check2-square"></i> Select Engines</h6>
                    <div class="form-check">
                        <input class="form-check-input engine-checkbox" type="checkbox" value="1" id="ae1-check" checked>
                        <label class="form-check-label" for="ae1-check">
                            <i class="bi bi-gear-fill text-success"></i> AE 1
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input engine-checkbox" type="checkbox" value="2" id="ae2-check" checked>
                        <label class="form-check-label" for="ae2-check">
                            <i class="bi bi-gear-fill text-success"></i> AE 2
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input engine-checkbox" type="checkbox" value="3" id="ae3-check" checked>
                        <label class="form-check-label" for="ae3-check">
                            <i class="bi bi-gear-fill text-success"></i> AE 3
                        </label>
                    </div>
                    <hr>
                    <button class="btn btn-sm btn-outline-primary w-100 mb-2" id="select-all">
                        <i class="bi bi-check-all"></i> Select All
                    </button>
                    <button class="btn btn-sm btn-outline-secondary w-100" id="deselect-all">
                        <i class="bi bi-x-square"></i> Deselect All
                    </button>
                </div>
            </div>

            <!-- Date Range Filter -->
            <div class="card">
                <div class="card-body">
                    <h6 class="card-title"><i class="bi bi-calendar-range"></i> Date Range</h6>
                    <form method="GET" id="filter-form">
                        <div class="mb-3">
                            <label for="start_date" class="form-label"><strong>Start Date</strong></label>
                            <input type="date" class="form-control" id="start_date" name="start_date" value="{{ start_date }}">
                        </div>
                        <div class="mb-3">
                            <label for="end_date" class="form-label"><strong>End Date</strong></label>
                            <input type="date" class="form-control" id="end_date" name="end_date" value="{{ end_date }}">
                        </div>
                        <button type="submit" class="btn btn-primary w-100 mb-2">
                            <i class="bi bi-funnel"></i> Apply Filter
                        </button>
                        <button type="button" class="btn btn-secondary w-100" onclick="window.location.href='{{ url_for('aux_engines') }}'">
                            <i class="bi bi-x-circle"></i> Reset
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="col-md-6 col-lg-7">
            <div class="card">
                <!-- Tab Navigation -->
                <div class="card-header p-0">
                    <ul class="nav nav-tabs nav-fill" id="ae-tabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="cooling-tab" data-bs-toggle="tab"
                                    data-bs-target="#cooling-content" type="button" role="tab">
                                <i class="bi bi-thermometer-half"></i> Cooling Water
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="lube-tab" data-bs-toggle="tab"
                                    data-bs-target="#lube-content" type="button" role="tab">
                                <i class="bi bi-droplet"></i> Lubricating Oil
                            </button>
                        </li>
                    </ul>
                </div>

                <!-- Tab Content -->
                <div class="card-body">
                    <div class="tab-content" id="ae-tab-content">
                        <!-- Cooling Water Tab -->
                        <div class="tab-pane fade show active" id="cooling-content" role="tabpanel">
                            <div id="cooling-charts"></div>
                        </div>

                        <!-- Lubricating Oil Tab -->
                        <div class="tab-pane fade" id="lube-content" role="tabpanel">
                            <div class="table-responsive">
                                <table class="table table-striped table-hover" id="lube-oil-table">
                                    <thead>
                                        <tr>
                                            <th>Engine</th>
                                            <th>Date</th>
                                            <th>Parameter</th>
                                            <th>Value</th>
                                            <th>Unit</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody id="lube-oil-tbody">
                                        <!-- Populated by JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Sidebar -->
        <div class="col-md-3 col-lg-3 mb-4">
            <!-- Vessel Selector (hidden for vessel users) -->
            {% if not current_user.is_vessel_user() %}
            <div class="card mb-3">
                <div class="card-body">
                    <h6 class="card-title"><i class="bi bi-ship"></i> Select Vessel</h6>
                    <select class="form-select" id="vessel-selector">
                        {% for v in vessels %}
                        <option value="{{ v.id }}" {% if v.id == vessel.id %}selected{% endif %}>
                            {{ v.vessel_name }}
                        </option>
                        {% endfor %}
                    </select>
                    <p class="text-muted small mt-2 mb-0">{{ vessel.vessel_id }}</p>
                </div>
            </div>
            {% endif %}

            <!-- Vessel Equipment Specifications -->
            {% if vessel_specs %}
            <div class="card mb-3">
                <div class="card-header" style="background-color: #6c757d; color: white;">
                    <h6 class="mb-0"><i class="bi bi-info-circle-fill"></i> Equipment Specifications</h6>
                </div>
                <div class="card-body">
                    {% for category, fields in vessel_specs.items() %}
                        {% if category != 'vessel_info' %}
                            {% for field_name, field_value in fields.items() %}
                                <div class="mb-2">
                                    <small class="text-muted d-block">{{ field_name }}</small>
                                    <strong class="small">{{ field_value }}</strong>
                                </div>
                            {% endfor %}
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Auxiliary Engine Alerts -->
            <div class="card border-danger">
                <div class="card-header" style="background-color: #dc3545; color: white;">
                    <h6 class="mb-0"><i class="bi bi-exclamation-triangle-fill"></i> Aux Engine Alerts</h6>
                </div>
                <div class="card-body">
                    {% if alerts %}
                        <div class="list-group list-group-flush">
                            {% for alert in alerts[:5] %}
                            <div class="list-group-item px-0">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="small">
                                        <strong>{{ alert.sampling_point_name or 'N/A' }}</strong><br>
                                        <span class="text-muted">{{ alert.parameter_name }}</span><br>
                                        <span class="badge bg-danger">{{ alert.measured_value }}</span>
                                        <small class="text-muted">{{ alert.alert_date[:10] }}</small>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p class="mb-0" style="color: #6e6e73;">
                            <i class="bi bi-check-circle-fill" style="color: #0071e3;"></i> No active alerts
                        </p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="{{ url_for('static', filename='js/plotly-2.27.0.min.js') }}"></script>
<script>
// Vessel selector - reload page when vessel changes
const vesselSelector = document.getElementById('vessel-selector');
if (vesselSelector) {
    vesselSelector.addEventListener('change', function() {
        const newVesselId = this.value;
        const currentUrl = new URL(window.location.href);
        currentUrl.searchParams.set('vessel_id', newVesselId);
        window.location.href = currentUrl.toString();
    });
}

// Color palette for engines
const ENGINE_COLORS = {
    1: '#2196F3',  // Blue
    2: '#4CAF50',  // Green
    3: '#FF9800'   // Orange
};

// Engine selection management
const engineCheckboxes = document.querySelectorAll('.engine-checkbox');
const selectAllBtn = document.getElementById('select-all');
const deselectAllBtn = document.getElementById('deselect-all');

selectAllBtn.addEventListener('click', () => {
    engineCheckboxes.forEach(cb => cb.checked = true);
    updateCharts();
});

deselectAllBtn.addEventListener('click', () => {
    engineCheckboxes.forEach(cb => cb.checked = false);
    updateCharts();
});

engineCheckboxes.forEach(cb => {
    cb.addEventListener('change', updateCharts);
});

function getSelectedEngines() {
    return Array.from(engineCheckboxes)
        .filter(cb => cb.checked)
        .map(cb => parseInt(cb.value));
}

// All data from backend
const allCoolingData = {{ all_engines_data | tojson }};
const allLubeData = {{ all_engines_data | tojson }};

function updateCharts() {
    const selectedEngines = getSelectedEngines();
    updateCoolingCharts(selectedEngines);
    updateLubeTable(selectedEngines);
}

function updateCoolingCharts(selectedEngines) {
    const coolingContainer = document.getElementById('cooling-charts');
    coolingContainer.innerHTML = '';

    // Organize cooling data by parameter
    const coolingByParam = {};
    selectedEngines.forEach(engineNum => {
        if (allCoolingData[engineNum] && allCoolingData[engineNum].cooling) {
            allCoolingData[engineNum].cooling.forEach(m => {
                if (!coolingByParam[m.parameter_name]) {
                    coolingByParam[m.parameter_name] = { unit: m.unit || '', engines: {} };
                }
                if (!coolingByParam[m.parameter_name].engines[engineNum]) {
                    coolingByParam[m.parameter_name].engines[engineNum] = [];
                }
                coolingByParam[m.parameter_name].engines[engineNum].push(m);
            });
        }
    });

    // Create a chart for each parameter
    Object.keys(coolingByParam).forEach(paramName => {
        const div = document.createElement('div');
        div.style.marginBottom = '30px';
        coolingContainer.appendChild(div);

        const paramInfo = coolingByParam[paramName];
        const traces = [];
        let allDates = [];

        selectedEngines.forEach(engineNum => {
            if (paramInfo.engines[engineNum]) {
                const data = paramInfo.engines[engineNum];
                traces.push({
                    x: data.map(m => m.measurement_date),
                    y: data.map(m => parseFloat(m.value)),
                    mode: 'lines+markers',
                    name: `AE${engineNum}`,
                    line: { color: ENGINE_COLORS[engineNum], width: 2 },
                    marker: { size: 6 }
                });
                allDates = allDates.concat(data.map(m => new Date(m.measurement_date)));
            }
        });

        // Calculate date range
        let minDate = new Date(Math.min(...allDates));
        let maxDate = new Date(Math.max(...allDates));
        if (minDate.toDateString() === maxDate.toDateString()) {
            minDate = new Date(minDate.getTime() - 86400000);
            maxDate = new Date(maxDate.getTime() + 86400000);
        }

        // Format last test date
        let lastTestDate = new Date(Math.max(...allDates.filter(d => !isNaN(d))));
        let lastTestDateStr = lastTestDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });

        const layout = {
            title: `${paramName}, Last Test Date ${lastTestDateStr}`,
            xaxis: {
                title: 'Date',
                tickformat: '%b %d, %Y',
                dtick: 86400000,
                range: [minDate, maxDate]
            },
            yaxis: { title: `${paramName} (${paramInfo.unit})` },
            hovermode: 'closest'
        };

        Plotly.newPlot(div, traces, layout, { responsive: true });
    });
}

function updateLubeTable(selectedEngines) {
    const tbody = document.getElementById('lube-oil-tbody');
    tbody.innerHTML = '';

    selectedEngines.forEach(engineNum => {
        if (allLubeData[engineNum] && allLubeData[engineNum].lube) {
            allLubeData[engineNum].lube.forEach(m => {
                const row = tbody.insertRow();
                row.className = 'engine-row';
                row.dataset.engine = engineNum;

                row.innerHTML = `
                    <td><i class="bi bi-gear-fill text-success"></i> AE${engineNum}</td>
                    <td>${m.measurement_date.substring(0, 10)}</td>
                    <td>${m.parameter_name}</td>
                    <td><strong>${m.value}</strong></td>
                    <td>${m.unit || '-'}</td>
                    <td>
                        <span class="badge ${
                            m.ideal_status === 'OKAY' ? 'bg-success' :
                            (m.ideal_status === 'TOO LOW' || m.ideal_status === 'TOO HIGH') ? 'bg-danger' :
                            'bg-warning text-dark'
                        }">
                            ${m.ideal_status || 'N/A'}
                        </span>
                    </td>
                `;
            });
        }
    });
}

// Initialize on page load
updateCharts();
</script>
{% endblock %}
