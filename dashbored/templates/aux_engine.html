{% extends "base.html" %}

{% block title %}Auxiliary Engine {{ engine_num }} - {{ vessel.vessel_name }}{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Breadcrumb and Title - Full Width -->
    <div class="row mb-3">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('dashboard', vessel_id=vessel.id) }}">Dashboard</a></li>
                    <li class="breadcrumb-item active">Auxiliary Engine {{ engine_num }}</li>
                </ol>
            </nav>
            <h2><i class="bi bi-gear text-success"></i> Auxiliary Engine {{ engine_num }} Analysis</h2>
            <p class="text-muted">{{ vessel.vessel_name }}</p>
        </div>
    </div>

    <!-- Date Range Filter - Full Width (100%) -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-calendar-range"></i> Date Range Filter</h5>
                </div>
                <div class="card-body">
                    <form method="GET" class="row g-3 align-items-end">
                        <div class="col-lg-3 col-md-4">
                            <label for="start_date" class="form-label"><strong>Start Date</strong></label>
                            <input type="date" class="form-control form-control-lg" id="start_date" name="start_date"
                                   value="{{ start_date }}">
                        </div>
                        <div class="col-lg-3 col-md-4">
                            <label for="end_date" class="form-label"><strong>End Date</strong></label>
                            <input type="date" class="form-control form-control-lg" id="end_date" name="end_date"
                                   value="{{ end_date }}">
                        </div>
                        <div class="col-lg-3 col-md-2">
                            <button type="submit" class="btn btn-primary btn-lg w-100">
                                <i class="bi bi-funnel"></i> Apply Filter
                            </button>
                        </div>
                        <div class="col-lg-3 col-md-2">
                            <button type="button" class="btn btn-outline-secondary btn-lg w-100"
                                    onclick="window.location.href='{{ url_for('aux_engine', engine_num=engine_num) }}'">
                                <i class="bi bi-x-circle"></i> Reset
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Sidebar and Main Content Row -->
    <div class="row">
        <!-- Left Sidebar - Engine Selector -->
        <div class="col-lg-2 col-md-3">
            <div class="card shadow sticky-top" style="top: 20px;">
                <div class="card-header bg-primary text-white text-center">
                    <h6 class="mb-0"><i class="bi bi-gear-fill"></i> Engines</h6>
                </div>
                <div class="list-group list-group-flush">
                    {% for i in range(1, 5) %}
                    <a href="{{ url_for('aux_engine', engine_num=i) }}"
                       class="list-group-item list-group-item-action text-center py-3 {% if engine_num == i %}active{% endif %}"
                       style="font-size: 1rem;">
                        <div><i class="bi bi-gear-fill d-block mb-1" style="font-size: 1.3rem;"></i></div>
                        <strong>AE {{ i }}</strong>
                    </a>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="col-lg-10 col-md-9">

    <!-- Cooling Water (Graphical) -->
    <div class="mb-4">
        <div class="card">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="bi bi-thermometer-half"></i> Cooling Water</h5>
            </div>
            <div class="card-body">
                {% if cooling_data %}
                    <div id="cooling-charts"></div>
                {% else %}
                    <div class="alert alert-info mb-0">
                        <i class="bi bi-info-circle"></i> No cooling water data available for the selected date range.
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Lubricating Oil (Tabular) -->
    <div class="mb-4">
        <div class="card">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0"><i class="bi bi-droplet"></i> Lubricating Oil</h5>
            </div>
            <div class="card-body">
                {% if lube_data %}
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Parameter</th>
                                    <th>Value</th>
                                    <th>Unit</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for measurement in lube_data %}
                                <tr>
                                    <td>{{ measurement.measurement_date[:10] }}</td>
                                    <td>{{ measurement.parameter_name }}</td>
                                    <td><strong>{{ measurement.value }}</strong></td>
                                    <td>{{ measurement.unit }}</td>
                                    <td>
                                        <span class="badge
                                            {% if measurement.ideal_status == 'OKAY' %}bg-success
                                            {% elif measurement.ideal_status in ['TOO LOW', 'TOO HIGH'] %}bg-danger
                                            {% else %}bg-warning text-dark{% endif %}">
                                            {{ measurement.ideal_status }}
                                        </span>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="alert alert-info mb-0">
                        <i class="bi bi-info-circle"></i> No lubricating oil data available for the selected date range.
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
        </div>
        <!-- End Main Content Area -->
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<!-- Plotly.js for charts -->
<script src="{{ url_for('static', filename='js/plotly-2.27.0.min.js') }}"></script>
<script>
// Cooling water charts (time series)
{% if cooling_data %}
const coolingData = {{ cooling_data | tojson }};
const coolingByParam = {};

// Convert date from YYYY-MM-DD or full timestamp to dd-mm-yy format
function formatDateForHover(dateStr) {
    // Extract date portion if it's a full timestamp
    const datePart = dateStr.split(' ')[0];
    const parts = datePart.split('-');
    if (parts.length === 3) {
        const year = parts[0].slice(-2); // Get last 2 digits of year
        const month = parts[1];
        const day = parts[2];
        return `${day}-${month}-${year}`;
    }
    return dateStr;
}

coolingData.forEach(m => {
    if (!coolingByParam[m.parameter_name]) {
        coolingByParam[m.parameter_name] = { dates: [], values: [], statuses: [] };
    }
    coolingByParam[m.parameter_name].dates.push(m.measurement_date);
    coolingByParam[m.parameter_name].values.push(m.value_numeric);
    coolingByParam[m.parameter_name].statuses.push(m.ideal_status);
});

Object.keys(coolingByParam).forEach(paramName => {
    const data = coolingByParam[paramName];
    const trace = {
        x: data.dates,
        y: data.values,
        mode: 'lines+markers',
        name: paramName,
        marker: {
            color: data.statuses.map(s => s === 'OKAY' ? 'green' : 'red')
        },
        hovertemplate: `${paramName}<br>Date: %{customdata}<br>Value: %{y}<extra></extra>`,
        customdata: data.dates.map(d => formatDateForHover(d))
    };

    // Calculate date range with 10% padding
    const allDates = data.dates.map(d => new Date(d));
    let minDate = new Date(Math.min(...allDates));
    let maxDate = new Date(Math.max(...allDates));

    // Add 10% padding on both sides
    const dateRange = maxDate.getTime() - minDate.getTime();
    const padding = dateRange * 0.10;
    minDate = new Date(minDate.getTime() - padding);
    maxDate = new Date(maxDate.getTime() + padding);

    // Handle single date case
    if (dateRange === 0) {
        minDate = new Date(minDate.getTime() - 86400000);
        maxDate = new Date(maxDate.getTime() + 86400000);
    }

    const div = document.createElement('div');
    div.style.marginBottom = '20px';
    document.getElementById('cooling-charts').appendChild(div);

    Plotly.newPlot(div, [trace], {
        title: paramName,
        xaxis: {
            title: 'Date',
            tickformat: '%d-%m-%y',
            range: [minDate, maxDate]
        },
        yaxis: { title: 'Value' }
    }, { responsive: true });
});
{% endif %}
</script>
{% endblock %}
