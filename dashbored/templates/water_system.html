{% extends "base.html" %}

{% block title %}{{ system_type }} - {{ vessel.vessel_name }}{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('dashboard', vessel_id=vessel.id) }}">Dashboard</a></li>
                    <li class="breadcrumb-item active">{{ system_type }}</li>
                </ol>
            </nav>

            <h2>
                {% if system_type == 'Potable Water' %}
                    <i class="bi bi-cup-straw text-info"></i>
                {% elif system_type == 'Treated Sewage Water' %}
                    <i class="bi bi-droplet-half text-secondary"></i>
                {% elif system_type == 'Ballast Water' %}
                    <i class="bi bi-water text-success"></i>
                {% elif system_type == 'EGCS' %}
                    <i class="bi bi-cloud text-muted"></i>
                {% endif %}
                {{ system_type }} Analysis
            </h2>
            <p class="text-muted">{{ vessel.vessel_name }} - {{ vessel.vessel_id }}</p>
        </div>
    </div>

    <div class="row">
        <!-- Main Content -->
        <div class="col-md-9 mb-4">
    <!-- Date Range Filter -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <form method="GET" class="row g-3 align-items-end">
                        <div class="col-md-4">
                            <label for="start_date" class="form-label">Start Date</label>
                            <input type="date" class="form-control" id="start_date" name="start_date"
                                   value="{{ start_date }}">
                        </div>
                        <div class="col-md-4">
                            <label for="end_date" class="form-label">End Date</label>
                            <input type="date" class="form-control" id="end_date" name="end_date"
                                   value="{{ end_date }}">
                        </div>
                        <div class="col-md-4">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-funnel"></i> Apply Filter
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="window.history.back()">
                                <i class="bi bi-x-circle"></i> Reset
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Water Quality Data (Tabular) -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header
                    {% if system_type == 'Potable Water' %}bg-info
                    {% elif system_type == 'Treated Sewage Water' %}bg-secondary
                    {% elif system_type == 'Ballast Water' %}bg-success
                    {% elif system_type == 'EGCS' %}bg-dark
                    {% endif %} text-white">
                    <h5 class="mb-0"><i class="bi bi-table"></i> {{ system_type }} Parameters</h5>
                </div>
                <div class="card-body">
                    {% if water_data %}
                        <div class="table-responsive">
                            <table class="table table-striped table-hover table-sm">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Parameter</th>
                                        <th>Value</th>
                                        <th>Unit</th>
                                        <th>Ideal Range</th>
                                        <th>Status</th>
                                        <th>Operator</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for measurement in water_data %}
                                    <tr>
                                        <td>{{ measurement.measurement_date[:10] }}</td>
                                        <td>{{ measurement.parameter_name }}</td>
                                        <td><strong>{{ measurement.value }}</strong></td>
                                        <td>{{ measurement.unit or '-' }}</td>
                                        <td>
                                            {% if measurement.ideal_low and measurement.ideal_high %}
                                                {{ measurement.ideal_low }} - {{ measurement.ideal_high }}
                                            {% else %}
                                                -
                                            {% endif %}
                                        </td>
                                        <td>
                                            <span class="badge
                                                {% if measurement.ideal_status == 'OKAY' %}bg-success
                                                {% elif measurement.ideal_status in ['TOO LOW', 'TOO HIGH'] %}bg-danger
                                                {% else %}bg-warning text-dark{% endif %}">
                                                {{ measurement.ideal_status }}
                                            </span>
                                        </td>
                                        <td>{{ measurement.operator_name or '-' }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>

                        <div class="mt-3">
                            <p class="text-muted mb-0">
                                <small>
                                    <i class="bi bi-info-circle"></i>
                                    Showing {{ water_data|length }} measurement(s) for {{ system_type }}
                                </small>
                            </p>
                        </div>
                    {% else %}
                        <div class="alert alert-info mb-0">
                            <i class="bi bi-info-circle"></i> No {{ system_type|lower }} data available for the selected date range.
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
        </div>

        <!-- Right Sidebar -->
        <div class="col-md-3 mb-4">
            <!-- Vessel Selector (hidden for vessel users) -->
            {% if not current_user.is_vessel_user() %}
            <div class="card mb-3">
                <div class="card-body">
                    <h6 class="card-title"><i class="bi bi-ship"></i> Select Vessel</h6>
                    <select class="form-select" id="vessel-selector">
                        {% for v in vessels %}
                        <option value="{{ v.id }}" {% if v.id == vessel.id %}selected{% endif %}>
                            {{ v.vessel_name }}
                        </option>
                        {% endfor %}
                    </select>
                    <p class="text-muted small mt-2 mb-0">{{ vessel.vessel_id }}</p>
                </div>
            </div>
            {% endif %}

            <!-- Vessel Equipment Specifications -->
            {% if vessel_specs %}
            <div class="card mb-3">
                <div class="card-header" style="background-color: #6c757d; color: white;">
                    <h6 class="mb-0"><i class="bi bi-info-circle-fill"></i> Equipment Specifications</h6>
                </div>
                <div class="card-body">
                    {% for category, fields in vessel_specs.items() %}
                        {% if category != 'vessel_info' %}
                            {% for field_name, field_value in fields.items() %}
                                <div class="mb-2">
                                    <small class="text-muted d-block">{{ field_name }}</small>
                                    <strong class="small">{{ field_value }}</strong>
                                </div>
                            {% endfor %}
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Water System Alerts -->
            <div class="card border-danger">
                <div class="card-header" style="background-color: #dc3545; color: white;">
                    <h6 class="mb-0"><i class="bi bi-exclamation-triangle-fill"></i> {{ system_type }} Alerts</h6>
                </div>
                <div class="card-body">
                    {% if alerts %}
                        <div class="list-group list-group-flush">
                            {% for alert in alerts[:5] %}
                            <div class="list-group-item px-0">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="small">
                                        <strong>{{ alert.sampling_point_name or 'N/A' }}</strong><br>
                                        <span class="text-muted">{{ alert.parameter_name }}</span><br>
                                        <span class="badge bg-danger">{{ alert.measured_value }}</span>
                                        <small class="text-muted">{{ alert.alert_date[:10] }}</small>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p class="mb-0" style="color: #6e6e73;">
                            <i class="bi bi-check-circle-fill" style="color: #0071e3;"></i> No active alerts
                        </p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Vessel selector - reload page when vessel changes
const vesselSelector = document.getElementById('vessel-selector');
if (vesselSelector) {
    vesselSelector.addEventListener('change', function() {
        const newVesselId = this.value;
        const currentUrl = new URL(window.location.href);
        currentUrl.searchParams.set('vessel_id', newVesselId);
        window.location.href = currentUrl.toString();
    });
}
</script>
{% endblock %}
